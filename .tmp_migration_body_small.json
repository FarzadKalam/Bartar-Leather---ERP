{"query":"BEGIN;\n\nALTER TABLE IF EXISTS public.production_orders\n  ADD COLUMN IF NOT EXISTS image_url text;\n\nALTER TABLE IF EXISTS public.production_boms\n  ADD COLUMN IF NOT EXISTS image_url text;\n\nCREATE TABLE IF NOT EXISTS public.record_files (\n  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,\n  module_id text NOT NULL,\n  record_id uuid NOT NULL,\n  file_url text NOT NULL,\n  file_type text NOT NULL DEFAULT \u0027file\u0027,\n  file_name text,\n  mime_type text,\n  sort_order int4 NOT NULL DEFAULT 0,\n  created_at timestamptz DEFAULT now()\n);\n\nALTER TABLE public.record_files ENABLE ROW LEVEL SECURITY;\n\nDROP POLICY IF EXISTS \"Public Access Record Files\" ON public.record_files;\nDROP POLICY IF EXISTS \"Public Insert Record Files\" ON public.record_files;\nDROP POLICY IF EXISTS \"Public Update Record Files\" ON public.record_files;\nDROP POLICY IF EXISTS \"Public Delete Record Files\" ON public.record_files;\n\nCREATE POLICY \"Public Access Record Files\"\nON public.record_files\nFOR SELECT\nUSING (true);\n\nCREATE POLICY \"Public Insert Record Files\"\nON public.record_files\nFOR INSERT\nWITH CHECK (true);\n\nCREATE POLICY \"Public Update Record Files\"\nON public.record_files\nFOR UPDATE\nUSING (true)\nWITH CHECK (true);\n\nCREATE POLICY \"Public Delete Record Files\"\nON public.record_files\nFOR DELETE\nUSING (true);\n\nCREATE INDEX IF NOT EXISTS idx_record_files_module_record\nON public.record_files(module_id, record_id);\n\nCREATE INDEX IF NOT EXISTS idx_record_files_created_at\nON public.record_files(created_at DESC);\n\nINSERT INTO public.record_files (\n  module_id,\n  record_id,\n  file_url,\n  file_type,\n  file_name,\n  mime_type,\n  sort_order,\n  created_at\n)\nSELECT\n  \u0027products\u0027,\n  pi.product_id,\n  pi.image_url,\n  \u0027image\u0027,\n  NULL,\n  NULL,\n  COALESCE(pi.sort_order, 0),\n  COALESCE(pi.created_at, now())\nFROM public.product_images pi\nWHERE pi.product_id IS NOT NULL\n  AND pi.image_url IS NOT NULL\n  AND NOT EXISTS (\n    SELECT 1\n    FROM public.record_files rf\n    WHERE rf.module_id = \u0027products\u0027\n      AND rf.record_id = pi.product_id\n      AND rf.file_url = pi.image_url\n  );\n\nCOMMIT;\n"}